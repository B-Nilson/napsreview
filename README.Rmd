---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# napsreview

<!-- badges: start -->
<!-- badges: end -->

`napsreview` is an R package with the goal of assessing the validity of the National Air Pollution Surveillance (NAPS) Program archive of Canadian quality-assured continuous air quality observations.

You can read more about the NAPS Program [here](https://open.canada.ca/data/en/dataset/1b36a356-defd-4813-acea-47bc3abd859b).

There are two key parts to `napsreview`: 

1. Creation of a local database of NAPS (and comparison) data (see [Build database](#build-database))
2. Validity assessment of NAPS data (see [Assess validity](#assess-validity))

## Installation

Using R, you can install the development version of napsreview from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("B-Nilson/napsreview")
```

# Build database

The NAPS dataset is split into annual files by pollutant. 
Below we download each of those files and dump them into a `duckdb` database, 
as well as format and combine them into a single dataset.

```{r collect_data, eval = FALSE}
library(napsreview)
desired_years <- 1974:2023
desired_pollutants <- c("PM25", "O3", "NO2")

# Define local paths (default is the install dir of napsreview)
#  but you can change that if needed
raw_data_dir <- "extdata/naps_raw" |>
  system.file(package = "napsreview")
db_path <- "extdata" |>
  system.file(package = "napsreview") |>
  file.path("naps.duckdb")

# Create (if needed) and connect to local database
db <- connect_to_database(db_path)
on.exit(DBI::dbDisconnect(db))

# Collect data for desired years/pollutants
naps_data <- desired_years |>
  get_naps_data(
    pollutants = desired_pollutants,
    raw_data_dir = raw_data_dir,
    check_if_raw_exists = TRUE # don't download if already exists locally
  )

# Write raw data to database if needed
if (!DBI::dbExistsTable(db, "raw_data")) {
  db |>
    archive_raw_naps_data(
      naps_data = naps_data,
      raw_data_tbl = "raw_data",
      raw_headers_tbl = "raw_data_headers"
    )
}

# Format data and write to database if needed
if (!DBI::dbExistsTable(db, "fmt_data")) {
  db |>
    archive_fmt_naps_data(
      naps_data = naps_data,
      fmt_data_tbl = "fmt_data",
      fmt_meta_tbl = "fmt_meta"
    )
}
```

And you can check that worked and view the data using the following:

```{r check_data, eval = FALSE}
library(napsreview)

# Connect to database (change path here if you did earlier as well)
db_path <- system.file("extdata", package = "napsreview") |>
  file.path("naps.duckdb")
db <- connect_to_database(db_path)
on.exit(DBI::dbDisconnect(db))

# Print the first 10 rows of each table
#   Note - these are lazy tables. 
#   You need to pass to dplyr::collect() if 
#   you want to query and load the data from the database
db |> dplyr::tbl("raw_data")
db |> dplyr::tbl("raw_data_headers")
db |> dplyr::tbl("fmt_data")
db |> dplyr::tbl("fmt_meta")

```

# Assess Validity

Several relatively minor issues have been found in the NAPS dataset:

* A major format change occurred around 2004 (see [Data Format Differences](#data-format-differences)).
* Site meta data values are inconsistent between files (see [Inconsistent Metadata](#inconsistent-metadata)).
* Some coordinate and concentration values are unrealistic (see [Unrealistic Values](#unrealistic-values)).

However, most noteably an inconsistent date mis-aligment was discovered for several sites/years (see [Date Misalignment](#date-misalignment)).


## Data Format Differences

The NAPS data format changed after 2004 to include French and English headers and several other format changes. Strangley, the 2002 files for NO2 and O3 use the new format, unlike the rest of the files for those pollutants prior to 2005.

Noteably:

* new files are encoded in UTF-8, old files are latin1
* new files have FR and EN headers (i.e. 'City//Ville' instead of 'City')
* new files have slightly different pre-data header format
* new files have a different date format (i.e. "2025-01-01" instead of "20040101")

```{r format_shift, eval = FALSE}
library(napsreview)

# Connect to database (change path here if you did earlier as well)
db_path <- system.file("extdata", package = "napsreview") |>
  file.path("naps.duckdb")
db <- connect_to_database(db_path)
on.exit(DBI::dbDisconnect(db))

# View encoding differences between versions (change path here if you did earlier as well)
raw_data_dir <- "extdata/naps_raw" |>
  system.file(package = "napsreview")
raw_data_dir |> 
  file.path("PM25_2002.csv") |> # v1 file
  readLines(encoding = "UTF-8") |> # actually latin1
  stringr::str_subset("\xb5") |> # so non-standard characters are broken
  head()
raw_data_dir |> 
  file.path("PM25_2006.csv") |> # same file
  readLines(encoding = "latin1") |> # now we try latin1
  stringr::str_subset("\xb5") |> # so nothing broken
  head()
raw_data_dir |> 
  file.path("PM25_2006.csv") |> # v2 file
  readLines(encoding = "UTF-8") |> # UTF-8 as expected
  stringr::str_subset("\xb5") |> # so nothing broken
  head()

# View file differences between versions
# Note: name and row_number are added by `napsreview` to ensure uniqueness in the db
# Note: 'Method' / 'Method Code//Code MÃ©thode' are included for non-PM25 pollutants for consistency, even though they are not found in the raw files
db |> dplyr::tbl("raw_data_v1")
db |> dplyr::tbl("raw_data_v2")

# View pre-data header differences between versions
db |> dplyr::tbl("raw_data_headers_v1")
db |> dplyr::tbl("raw_data_headers_v2")

# View date format differences between versions
db |>
  dplyr::tbl("raw_data_v1") |>
  head(n = 1) |>
  dplyr::pull("Date") |>
  as.character()
db |>
  dplyr::tbl("raw_data_v2") |>
  head(n = 1) |>
  dplyr::pull("Date//Date") |>
  as.character()
```

These files have been identified as having the old format:

```{r format_shift_summary, eval = TRUE, echo = FALSE}
library(napsreview)

"extdata/issues/old_format_files.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tidyr::separate(file_name, into = c("pollutant", "year"), sep = "_") |>
  dplyr::group_by(pollutant) |>
  dplyr::summarise(years = sentence_range(as.integer(year))) |>
  tidyr::unite(col = "text", pollutant, years, sep = ": ") |>
  dplyr::pull(text) |>
  paste(collapse = "\n") |>
  cat()
```

## Inconsistent Metadata

Every entry in the raw NAPS data has latitude, longitude, province/territory, and city information.
However, for many sites these values are inconsistent between files.

For example, lat/lng values have differing precisions between files causing slight shifts in location.

```{r inconsistent_coords, eval = TRUE, echo = FALSE}
"extdata/issues/multiple_loc_sites.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble() |>
  dplyr::mutate(dplyr::across(c(lat, lng), as.character))
```

In addition, city names are inconsistently spelled between files

```{r inconsistent_city_spelling, eval = TRUE, echo = FALSE}
"extdata/issues/multiple_city_spellings.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble()
```

and some sites have multiple city names across files.

```{r inconsistent_site_city, eval = TRUE, echo = FALSE}
"extdata/issues/multiple_city_sites.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble()
```

## Unrealistic Values

Some values in the raw data are unrealistically high or low, coordinates exist that are outside Canada, and some site ids are not properly padded with leading zeros.

Here is a sample of files/sites with negative concentrations:
```{r negatives, eval = TRUE, echo = FALSE}
"extdata/issues/invalid_values.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble() |>
  dplyr::filter(has_negatives) |>
  dplyr::select(file_name, site_ids)
```

Here is a sample of files/sites with concentrations above 2000:
```{r extremes, eval = TRUE, echo = FALSE}
"extdata/issues/invalid_values.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble() |>
  dplyr::filter(has_values_above_2000) |>
  dplyr::select(file_name, site_ids)
```

Here is a sample of files/sites with coordinates outside of Canada:
```{r unrealistic_coords, eval = TRUE, echo = FALSE}
"extdata/issues/invalid_values.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble() |>
  dplyr::filter(has_bad_lat_or_lng) |>
  dplyr::select(file_name, site_ids)
```

Here is a sample of files/sites with invalid site ids:
```{r unrealistic_id, eval = TRUE, echo = FALSE}
"extdata/issues/invalid_values.csv" |>
  system.file(package = "napsreview") |>
  read.csv() |>
  tibble::as_tibble() |>
  dplyr::filter(has_bad_site_id) |>
  dplyr::select(file_name, site_ids)
```

## Date Misalignment

Inconsistencies have been found in the hourly alignment of NAPS data for some sites in entirety, and for select years for some sites, when compared to the same station's data sourced directly from the BC Government archive. Due to NAPS recieving their data from BC, this issue is likely due to an error in how the NAPS data are converted to local hour and archived.

Given the presence of the BC Government archive with clear documentation on data timezone, a standardized data format, and the ability to collect data programmatically, this issue has only been assessed for BC. However, it is likely that this issue affects data from across the country.
